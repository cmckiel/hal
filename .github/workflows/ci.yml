name: CI Pipeline

on:
  push:
    branches: ["**"]

jobs:
  build:
    name: Build ${{ matrix.preset }}
    runs-on: ubuntu-latest
    container:
      image: cmckiel/hal-build-environment:latest

    strategy:
      matrix:
        preset: [desktop-debug, embedded-debug, embedded-release]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Configure (${{ matrix.preset }})
      run: cmake --preset ${{ matrix.preset }}

    - name: Build (${{ matrix.preset }})
      run: cmake --build --preset ${{ matrix.preset }}

    # Upload embedded-debug artifacts for further testing
    - name: Upload embedded-debug test binary artifact
      if: matrix.preset == 'embedded-debug'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-debug-${{ github.sha }}
        path: |
          build/embedded-debug/hal_integration_test.bin
          build/embedded-debug/hal_integration_test.elf
        retention-days: 7

    # Create an embedded-debug build tree archive
    - name: Create embedded-debug archive
      if: matrix.preset == 'embedded-debug'
      run: |
        # Create a tarball that preserves permissions
        cd build/embedded-debug
        tar -czf ../../embedded-debug.tar.gz .
        cd ../..

    # Upload embedded-debug build tree for later packaging
    - name: Upload embedded-debug archive
      if: matrix.preset == 'embedded-debug'
      uses: actions/upload-artifact@v4
      with:
        name: embedded-debug-${{ github.sha }}
        path: embedded-debug.tar.gz
        retention-days: 7

    # Upload embedded-release artifacts for further testing
    - name: Upload embedded-release test binary artifact
      if: matrix.preset == 'embedded-release'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-release-${{ github.sha }}
        path: |
          build/embedded-release/hal_integration_test.bin
          build/embedded-release/hal_integration_test.elf
        retention-days: 7

    # Create an embedded-release build tree archive
    - name: Create embedded-release archive
      if: matrix.preset == 'embedded-release'
      run: |
        # Create a tarball that preserves permissions
        cd build/embedded-release
        tar -czf ../../embedded-release.tar.gz .
        cd ../..

    # Upload embedded-release build tree for later packaging
    - name: Upload embedded-release archive
      if: matrix.preset == 'embedded-release'
      uses: actions/upload-artifact@v4
      with:
        name: embedded-release-${{ github.sha }}
        path: embedded-release.tar.gz
        retention-days: 7

    - name: Create desktop-debug archive
      if: matrix.preset == 'desktop-debug'
      run: |
        # Create a tarball that preserves permissions
        cd build/desktop-debug
        tar -czf ../../desktop-debug.tar.gz .
        cd ../..

    - name: Upload desktop-debug archive
      if: matrix.preset == 'desktop-debug'
      uses: actions/upload-artifact@v4
      with:
        name: desktop-debug-${{ github.sha }}
        path: desktop-debug.tar.gz
        retention-days: 7

  analyze:
    name: Analyze with ${{ matrix.preset }}
    needs: build
    runs-on: ubuntu-latest
    container:
      image: cmckiel/hal-build-environment:latest

    strategy:
      matrix:
        preset: [cppcheck, clang-tidy]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download desktop-debug archive
      uses: actions/download-artifact@v4
      with:
        name: desktop-debug-${{ github.sha }}
        path: ./

    - name: Extract desktop-debug archive
      run: |
        mkdir -p build/desktop-debug
        tar -xzf desktop-debug.tar.gz -C build/desktop-debug

    - name: Analyze with ${{ matrix.preset }}
      run: |
        cmake --build --preset desktop-debug -t ${{ matrix.preset }}

  unit-tests:
    name: Test On Desktop (unit tests)
    needs: build
    runs-on: ubuntu-latest
    container:
      image: cmckiel/hal-build-environment:latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download desktop-debug archive
      uses: actions/download-artifact@v4
      with:
        name: desktop-debug-${{ github.sha }}
        path: ./

    - name: Extract desktop-debug archive
      run: |
        mkdir -p build/desktop-debug
        tar -xzf desktop-debug.tar.gz -C build/desktop-debug

    - name: Run unit tests
      run: |
        ctest --preset desktop-debug

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results-${{ github.sha }}
        path: |
          build/desktop-debug/Testing/
        retention-days: 7

  hardware-test:
    name: Test On Target Hardware (${{ matrix.preset }})
    needs: build
    runs-on: [self-hosted, Linux, ARM64]

    strategy:
      matrix:
        preset: [debug, release]

    # @todo: This timeout doesn't seem to work. Need a way
    # to detect that the runner is offline to avoid wasting CI minutes.
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download firmware (${{ matrix.preset }})
      uses: actions/download-artifact@v4
      with:
        name: firmware-${{ matrix.preset }}-${{ github.sha }}
        path: ./firmware-${{ matrix.preset }}

    - name: Flash firmware to target
      run: |
        st-flash write ./firmware-${{ matrix.preset }}/hal_integration_test.bin 0x8000000 && st-flash reset

    - name: Wait for target to boot
      run: sleep 1

    - name: Run hardware test
      run: |
        python3 tests/integration/uart_test.py
        echo "Test completed with exit code: $?"

    - name: Reset hardware (cleanup)
      run: |
        # Reset the target to a known state
        st-flash reset

  docs:
    name: Build documentation
    needs: build
    runs-on: ubuntu-latest
    container:
      image: cmckiel/hal-build-environment:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download desktop-debug archive
        uses: actions/download-artifact@v4
        with:
          name: desktop-debug-${{ github.sha }}
          path: ./

      - name: Extract desktop-debug archive
        run: |
          mkdir -p build/desktop-debug
          tar -xzf desktop-debug.tar.gz -C build/desktop-debug

      - name: Build Doxygen docs
        run: |
          cmake --build --preset desktop-debug -t docs

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-${{ github.sha }}
          path: build/desktop-debug/docs
          retention-days: 7

  deploy-docs:
    name: Deploy documentation to GitHub Pages
    permissions:
      contents: write
    needs: docs
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download docs artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-${{ github.sha }}
          path: ./public

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./public

  install-and-package:
    name: Package embedded-${{ matrix.preset }}
    needs: hardware-test
    runs-on: ubuntu-latest
    container:
      image: cmckiel/hal-build-environment:latest

    strategy:
      matrix:
        preset: [debug, release]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download embedded-${{ matrix.preset }} archive
      uses: actions/download-artifact@v4
      with:
        name: embedded-${{ matrix.preset }}-${{ github.sha }}
        path: ./

    - name: Extract embedded-${{ matrix.preset }} archive
      run: |
        mkdir -p build/embedded-${{ matrix.preset }}
        tar -xzf embedded-${{ matrix.preset }}.tar.gz -C build/embedded-${{ matrix.preset }}

    - name: Package embedded-${{ matrix.preset }}
      run: |
        cd build/embedded-${{ matrix.preset }}
        cpack
        cd ../..

    - name: Consume package in mock project
      run: |
        mkdir -p /tmp/hal-consumer
        cp build/embedded-${{ matrix.preset }}/Hal-*.tar.gz /tmp/hal-consumer/hal-package.tar.gz
        cd /tmp/hal-consumer

        # Create CMakeLists.txt
        cat > CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.20)
        project(hal_consumer C)

        find_package(Hal 0.1.0 REQUIRED CONFIG)

        add_executable(hal_consumer main.c)
        target_link_libraries(hal_consumer PRIVATE Hal::stm32f4_hal)
        EOF

        # Create main.c
        echo 'int main(void) { return 0; }' > main.c

        # Extract the package over and place it in hal-package/
        mkdir hal-package
        tar -xzf hal-package.tar.gz --directory hal-package --strip-components=1

        # Build and link the project to Hal Package
        cmake -S . -B build -DCMAKE_PREFIX_PATH="hal-package"
        cmake --build build/
